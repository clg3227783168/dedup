# 块级去重功能测试报告

**项目名称**: dedup-snapshotter
**测试日期**: ____年__月__日
**测试环境**: Ubuntu/CentOS ____
**内核版本**: `uname -r` = ____________
**测试人员**: ____________

---

## 一、测试环境配置

### 1.1 系统信息

```bash
# 记录以下命令输出
uname -a
# 输出: _______________________________________________

cat /etc/os-release | grep PRETTY_NAME
# 输出: _______________________________________________

# KSM支持检查
ls -l /sys/kernel/mm/ksm/
# 输出: _______________________________________________
```

### 1.2 依赖软件版本

| 软件 | 版本 | 检查命令 |
|-----|------|---------|
| Go | _______ | `go version` |
| containerd | _______ | `containerd --version` |
| EROFS工具 | _______ | `mkfs.erofs --version` |

---

## 二、单元测试结果

### 2.1 块级去重测试

**测试命令**:
```bash
cd /home/clg/dedup/dedup-snapshotter
go test -v ./pkg/storage -run TestChunkLevelDeduplication
```

**测试结果**:
- [ ] PASS ✓
- [ ] FAIL ✗

**输出摘要**:
```
# 粘贴测试输出
```

**关键指标**:
- 测试文件数: _____
- 唯一块数: _____ (预期: 3)
- 去重率: _____% (预期: ~43%)

---

### 2.2 固定块大小测试

**测试命令**:
```bash
go test -v ./pkg/storage -run TestBlockBoundaryFixedSize
```

**测试结果**:
- [ ] PASS ✓
- [ ] FAIL ✗

**验证点**:
- [ ] 使用固定4MB块切分
- [ ] 块边界对齐正确
- [ ] 非内容感知分块(CDC)

---

### 2.3 元数据保留测试

**测试命令**:
```bash
go test -v ./pkg/storage -run TestMetadataPreservation
```

**测试结果**:
- [ ] PASS ✓
- [ ] FAIL ✗

**验证项**:
- [ ] 文件权限独立 (fileA=755, fileB=644)
- [ ] 时间戳独立
- [ ] 内容哈希相同
- [ ] 块被共享存储

---

### 2.4 去重率测试

**测试命令**:
```bash
go test -v ./pkg/storage -run TestDeduplicationRatio
```

**测试结果**:
- [ ] PASS ✓
- [ ] FAIL ✗

**统计数据**:
- 原始数据大小: _____ MB
- 去重后大小: _____ MB
- 去重率: _____% (预期: 40-50%)
- 唯一块数: _____ (预期: 11)

---

### 2.5 内存去重测试

**测试命令**:
```bash
go test -v ./pkg/memory -run TestMemoryDeduplication
```

**测试结果**:
- [ ] PASS ✓
- [ ] FAIL ✗

**统计数据**:
- 唯一页面数: _____
- 合并页面数: _____
- 节省内存: _____ bytes

**KSM测试**:
```bash
go test -v ./pkg/memory -run TestKSMController
```

**测试结果**:
- [ ] PASS ✓
- [ ] FAIL ✗

**KSM统计**:
- pages_sharing: _____
- pages_shared: _____
- 节省内存: _____ MB

---

## 三、集成测试结果

### 3.1 块级去重集成测试

**测试命令**:
```bash
cd /home/clg/dedup/tests/integration
./block_dedup_test.sh
```

**测试结果**:
- 通过测试数: _____ / _____
- 失败测试数: _____

**详细结果**:

| 测试用例 | 结果 | 备注 |
|---------|------|------|
| 跨文件块去重 | ✓/✗ | 块数: ___, 去重率: ___% |
| 固定块大小验证 | ✓/✗ | |
| 元数据完整性 | ✓/✗ | |
| 去重率统计 | ✓/✗ | |

**输出摘要**:
```
# 粘贴测试总结输出
```

---

### 3.2 内存去重集成测试

**测试命令**:
```bash
sudo ./memory_dedup_test.sh
```

**测试结果**:
- 通过测试数: _____ / _____
- 失败测试数: _____

**详细结果**:

| 测试用例 | 结果 | 备注 |
|---------|------|------|
| KSM可用性检查 | ✓/✗ | |
| KSM启用/禁用 | ✓/✗ | |
| KSM统计读取 | ✓/✗ | |
| 实际去重效果 | ✓/✗ | 节省: ___ MB |

**KSM参数**:
```bash
cat /sys/kernel/mm/ksm/sleep_millisecs
# 输出: _____

cat /sys/kernel/mm/ksm/pages_to_scan
# 输出: _____
```

---

## 四、性能测试结果

### 4.1 去重性能基准

**测试命令**:
```bash
go test -bench=. ./pkg/storage -benchtime=10s
```

**测试结果**:
```
# 粘贴benchmark输出
BenchmarkChunkDedup-8    ____    ____ ns/op
```

**性能指标**:
- 单次去重操作耗时: _____ ns
- 吞吐量: _____ ops/s

---

### 4.2 内存去重性能

**测试命令**:
```bash
go test -bench=. ./pkg/memory -benchtime=10s
```

**测试结果**:
```
# 粘贴benchmark输出
BenchmarkMemoryDedup-8    ____    ____ ns/op
```

---

## 五、实际场景测试

### 5.1 真实镜像去重测试

**测试场景**: 拉取多个Ubuntu镜像

**操作步骤**:
1. 拉取镜像
   ```bash
   ctr image pull docker.io/library/ubuntu:20.04
   ctr image pull docker.io/library/ubuntu:22.04
   ctr image pull docker.io/library/ubuntu:24.04
   ```

2. 查看去重效果
   ```bash
   du -sh /var/lib/dedup-snapshotter/chunks
   ls -1 /var/lib/dedup-snapshotter/chunks | wc -l
   ```

**测试结果**:

| 指标 | 数值 |
|-----|------|
| 镜像数量 | 3 |
| 原始总大小 | _____ MB |
| 去重后大小 | _____ MB |
| 独特块数 | _____ |
| 去重率 | _____% |

**截图**:
```
# 附上du -sh输出的截图或文本
```

---

### 5.2 容器启动测试

**测试**: 启动多个相同容器,验证内存去重

**操作**:
```bash
for i in {1..5}; do
  ctr run -d docker.io/library/nginx:latest nginx-$i
done
```

**KSM统计**:
```bash
# 启动前
pages_sharing_before=$(cat /sys/kernel/mm/ksm/pages_sharing)
# 值: _____

# 等待30秒

# 启动后
pages_sharing_after=$(cat /sys/kernel/mm/ksm/pages_sharing)
# 值: _____

# 增量
delta=$((pages_sharing_after - pages_sharing_before))
# 值: _____

# 节省内存
saved_mb=$((delta * 4 / 1024))
# 值: _____ MB
```

---

## 六、快速演示测试

**测试命令**:
```bash
cd /home/clg/dedup/tests
./quick_demo.sh
```

**演示效果**:
- [ ] 成功展示块级去重流程
- [ ] 去重率统计显示正确
- [ ] 块引用关系图清晰

**输出截图/文本**:
```
# 粘贴演示输出
```

**去重效果**:
- 原始大小: _____ MB
- 去重后: _____ MB
- 节省: _____%

---

## 七、评分项验证总结

### 7.1 功能性指标(60分)

| 评分项 | 分值 | 测试结果 | 证据 |
|-------|------|---------|------|
| 稳定性-场景鲁棒性 | 6分 | ✓/✗ | 所有测试用例通过 |
| 稳定性-异常重建 | 4分 | ✓/✗ | 崩溃恢复测试 |
| 完整性-数据去重 | 10分 | ✓/✗ | 单元测试+集成测试 |
| 先进性-块粒度去重 | 3分 | ✓/✗ | TestChunkLevelDeduplication |
| 先进性-不破坏元数据 | 3分 | ✓/✗ | TestMetadataPreservation |
| 先进性-内存去重 | 4分 | ✓/✗ | TestMemoryDeduplication |

**总分**: _____ / 30 (先进性评分项)

---

### 7.2 关键证据清单

**块粒度去重证据**:
- [ ] 单元测试通过截图
- [ ] chunks目录文件列表
- [ ] 去重率统计数据
- [ ] 跨文件块共享示例

**元数据完整性证据**:
- [ ] stat命令输出对比
- [ ] 相同内容不同权限文件示例
- [ ] 符号链接测试

**内存去重证据**:
- [ ] KSM启用状态
- [ ] pages_sharing统计
- [ ] 多容器场景内存节省数据

---

## 八、问题与改进

### 8.1 测试中发现的问题

1. **问题描述**: ________________________________
   - 严重程度: 高/中/低
   - 影响范围: ________________________________
   - 解决方案: ________________________________

2. **问题描述**: ________________________________
   - 严重程度: 高/中/低
   - 影响范围: ________________________________
   - 解决方案: ________________________________

---

### 8.2 改进建议

1. ________________________________________________
2. ________________________________________________
3. ________________________________________________

---

## 九、测试结论

### 9.1 总体评价

- [ ] 完全满足块级去重要求
- [ ] 基本满足要求,部分功能需改进
- [ ] 不满足要求,需要重大修改

### 9.2 功能完成度

| 功能 | 完成度 | 说明 |
|-----|--------|------|
| 块粒度去重 | ___% | |
| 元数据保留 | ___% | |
| 内存去重 | ___% | |
| 性能优化 | ___% | |

### 9.3 建议评分

根据测试结果,建议评分:

- 块粒度去重 (3分): _____ 分
- 不破坏元数据 (3分): _____ 分
- 内存去重 (4分): _____ 分

**总计**: _____ / 10 分

---

## 十、附录

### 10.1 测试日志

完整测试日志文件路径:
- 单元测试日志: ________________________________
- 集成测试日志: ________________________________
- 性能测试日志: ________________________________

### 10.2 测试数据

测试数据存储路径:
- 测试文件: ________________________________
- chunks目录快照: ________________________________
- 统计数据: ________________________________

### 10.3 相关截图

1. chunks目录结构: ________________________________
2. 去重率统计: ________________________________
3. KSM统计信息: ________________________________
4. 测试通过截图: ________________________________

---

**报告完成日期**: ____年__月__日
**审核人**: ____________
**审核日期**: ____年__月__日

# Dedup Snapshotter 使用指南 - 自动转换版

## 核心特性

✅ **自动层转换** - 镜像拉取时自动转换为 EROFS 格式
✅ **按需加载** - 基于 EROFS over fscache 的懒加载
✅ **块级去重** - 自动检测和去重相同数据块
✅ **异步预取** - 智能预取提升启动速度

## 快速开始

### 1. 安装依赖

```bash
# 安装 EROFS 工具
sudo yum install erofs-utils  # CentOS/RHEL
# 或
sudo apt install erofs-utils  # Ubuntu/Debian

# 检查内核支持 (需要 >= 5.4, fscache 需要 >= 5.19)
uname -r
grep erofs /proc/filesystems
```

### 2. 启动 Snapshotter

```bash
# 编译
cd dedup-snapshotter
go build -o bin/dedup-snapshotter ./cmd

# 启动服务
sudo ./bin/dedup-snapshotter
```

或使用 systemd:

```bash
sudo systemctl start dedup-snapshotter
sudo systemctl status dedup-snapshotter
```

### 3. 拉取镜像(自动转换)

```bash
# 使用 dedup snapshotter 拉取镜像
# snapshotter 会自动将层转换为 EROFS 格式
sudo ctr image pull --snapshotter=dedup docker.io/godnf/tst-lazy-pull:latest

# 查看日志,确认自动转换
sudo journalctl -u dedup-snapshotter -f
# 应该看到: "detected new layer xxx, auto-converting to EROFS"
```

### 4. 运行容器

```bash
# 直接运行,使用按需加载
sudo ctr run --snapshotter=dedup --rm \
    docker.io/godnf/tst-lazy-pull:latest \
    test-container

# 或交互式
sudo ctr run --snapshotter=dedup -t \
    docker.io/library/alpine:latest \
    test-alpine sh
```

## 工作原理

### 自动转换流程

```
用户: ctr image pull --snapshotter=dedup <image>
         ↓
Containerd 拉取 OCI 层
         ↓
每一层调用: snapshotter.Prepare()
         ↓
自动检测新层: autoConvertLayer()
    - 检查是否已有 EROFS 镜像
    - 检查快照目录是否有新内容
         ↓
自动转换:
    - 使用 containerd/archive.Apply 解压层
    - 处理 whiteout 文件
    - 块级去重
    - 构建 EROFS 镜像
    - 注册到 fscache
         ↓
层准备完成,继续下一层
```

### 按需加载流程

```
用户: ctr run --snapshotter=dedup <image> <container>
         ↓
Snapshotter.Mounts() 挂载 rootfs
    - 使用 EROFS over fscache 挂载
    - 仅元数据在本地,数据未下载
         ↓
容器启动并运行
         ↓
进程访问文件 → fscache 检查缓存
    ├─ 命中 → 直接读取(内核态,零拷贝)
    └─ 未命中 → 通知 dedupd
                  ↓
            dedupd 从网络拉取数据
                  ↓
            写入 fscache 缓存
                  ↓
            唤醒等待进程
                  ↓
            进程读取成功
```

## 验证按需加载

### 检查 EROFS 镜像

```bash
# 查看已转换的 EROFS 镜像
ls -lh /var/lib/containerd/io.containerd.snapshotter.v1.dedup/images/

# 查看镜像详情
sudo file /var/lib/containerd/io.containerd.snapshotter.v1.dedup/images/*.erofs
```

### 监控按需加载

```bash
# 监控 dedupd 日志
sudo journalctl -u dedup-snapshotter -f | grep -E "cache|fetch|download"

# 查看 fscache 统计
cat /proc/fs/fscache/stats 2>/dev/null || echo "fscache 未启用"

# 监控缓存增长
watch -n 1 'du -sh /var/lib/containerd/io.containerd.snapshotter.v1.dedup/cache/'
```

### 性能对比

```bash
# 测试 1: 使用 dedup snapshotter (按需加载)
time sudo ctr run --snapshotter=dedup --rm \
    docker.io/library/nginx:latest test-nginx1 nginx -v

# 测试 2: 使用默认 overlayfs
time sudo ctr run --rm \
    docker.io/library/nginx:latest test-nginx2 nginx -v
```

按需加载应该显著减少镜像拉取时间(仅下载元数据)。

## 配置选项

### 启用/禁用 Fscache

编辑配置文件 `/etc/dedup-snapshotter/config.json`:

```json
{
  "root": "/var/lib/containerd/io.containerd.snapshotter.v1.dedup",
  "use_erofs": true,
  "use_fscache": true,
  "ksm": {
    "enabled": true,
    "scan_interval": 100
  },
  "log_level": "info"
}
```

### 环境变量

```bash
# Snapshotter 根目录
export ROOT=/var/lib/containerd/io.containerd.snapshotter.v1.dedup

# Socket 地址
export ADDRESS=/run/containerd/dedup-snapshotter.sock

# 配置文件路径
export CONFIG=/etc/dedup-snapshotter/config.json

# 日志级别
export LOG_LEVEL=debug
```

## 故障排查

### 问题 1: 镜像拉取失败

```bash
# 检查 snapshotter 是否运行
sudo systemctl status dedup-snapshotter

# 检查日志
sudo journalctl -u dedup-snapshotter -n 100

# 检查 socket
ls -l /run/containerd/dedup-snapshotter.sock
```

### 问题 2: 自动转换失败

查看日志中的错误:

```bash
sudo journalctl -u dedup-snapshotter | grep -E "auto-convert|erofs|ERROR"
```

常见原因:
- `mkfs.erofs` 未安装
- 权限不足
- 磁盘空间不足

### 问题 3: 容器启动失败

```bash
# 检查 EROFS 镜像完整性
sudo ls -lh /var/lib/containerd/io.containerd.snapshotter.v1.dedup/images/

# 手动挂载测试
sudo mkdir -p /tmp/test-mount
sudo mount -t erofs -o loop,ro \
    /var/lib/containerd/io.containerd.snapshotter.v1.dedup/images/<layer-id>.erofs \
    /tmp/test-mount
ls /tmp/test-mount
sudo umount /tmp/test-mount
```

### 问题 4: Fscache 不工作

检查内核版本:

```bash
uname -r  # 需要 >= 5.19

# 检查 fscache 支持
grep CONFIG_CACHEFILES=y /boot/config-$(uname -r)

# 检查模块加载
lsmod | grep -E "fscache|cachefiles"

# 手动加载
sudo modprobe cachefiles
```

如果内核不支持,会自动回退到 loop mount 模式。

### 问题 5: 权限错误

```bash
# 确保目录权限正确
sudo chown -R root:root /var/lib/containerd/io.containerd.snapshotter.v1.dedup
sudo chmod -R 700 /var/lib/containerd/io.containerd.snapshotter.v1.dedup
```

## 与默认 Snapshotter 对比

| 特性 | Overlayfs (默认) | Dedup Snapshotter |
|------|-----------------|-------------------|
| 镜像存储 | 完整下载所有层 | 仅元数据 + 按需数据 |
| 启动速度 | 慢(需下载完整镜像) | 快(仅元数据) |
| 磁盘占用 | 高(完整镜像) | 低(去重 + 按需) |
| 内存占用 | 低 | 中(KSM 去重) |
| 块级去重 | ❌ | ✅ |
| 内存去重 | ❌ | ✅ (KSM) |
| 网络优化 | ❌ | ✅ (异步预取) |

## 进阶使用

### 查看去重统计

```bash
# API 服务器默认运行在 :8080
curl http://localhost:8080/stats | jq
```

### 预取优化

```bash
# 基于 trace 文件预取
# (需要先生成访问 trace)
curl -X POST http://localhost:8080/prefetch \
  -d '{"image_id":"<layer-id>","trace_file":"/path/to/trace"}'
```

### 审计日志

```bash
# 查看操作审计
sudo sqlite3 /var/lib/containerd/io.containerd.snapshotter.v1.dedup/audit.db \
  "SELECT * FROM audit_logs ORDER BY timestamp DESC LIMIT 10;"
```

## 清理

### 删除未使用的层

```bash
# Containerd 会自动清理
sudo ctr content ls

# 手动清理 snapshotter 缓存
sudo rm -rf /var/lib/containerd/io.containerd.snapshotter.v1.dedup/cache/*
```

### 完全卸载

```bash
# 停止服务
sudo systemctl stop dedup-snapshotter

# 删除数据
sudo rm -rf /var/lib/containerd/io.containerd.snapshotter.v1.dedup

# 删除配置
sudo rm -rf /etc/dedup-snapshotter
```

## 参考资料

- [EROFS 内核文档](https://www.kernel.org/doc/html/latest/filesystems/erofs.html)
- [Fscache 文档](https://www.kernel.org/doc/html/latest/filesystems/caching/fscache.html)
- [Containerd Snapshotter](https://github.com/containerd/containerd/tree/main/snapshots)
- 项目源码: [核心代码解析.md](核心代码解析.md)

# Dedup-Snapshotter 使用指南 - 镜像拉取与部署

## 一、项目架构概述

这是一个 containerd 的去重 snapshotter 插件,实现了以下核心功能:

### 核心特性
1. **块级去重** - 4MB 块大小的数据去重,节省存储空间
2. **EROFS 文件系统** - 使用只读文件系统,提升性能
3. **按需加载** - 支持 fscache 和 LazyLoader 两种模式,加速冷启动
4. **内存去重** - 使用 KSM (Kernel Samepage Merging) 减少内存占用

### 架构组件
- `dedup-snapshotter` - 主服务进程,作为 containerd 的 proxy plugin
- `dedupd` - 独立的预取守护进程,负责按需下载数据块
- `DedupStore` - 存储层,负责数据去重和 EROFS 镜像构建
- `MountManager` - 挂载管理器,支持 fscache 和传统 loop 设备挂载

---

## 二、环境准备

### 2.1 系统要求

```bash
# 操作系统
OpenCloudOS / CentOS / Ubuntu 20.04+

# 内核要求
Linux 5.4+ (建议 5.15+，支持 fscache 和 EROFS)

# 必需工具
- containerd 1.6+
- erofs-utils
- go 1.20+
```

### 2.2 安装依赖

#### CentOS/OpenCloudOS
```bash
# 安装 erofs-utils
sudo yum install -y erofs-utils

# 安装 containerd (如果还没安装)
sudo yum install -y containerd

# 检查 KSM 支持
ls /sys/kernel/mm/ksm/
```

### 2.3 检查内核模块

```bash
# 检查 EROFS 支持
modprobe erofs
lsmod | grep erofs

# 检查 fscache 支持
ls /dev/cachefiles
```

---

## 三、构建和安装 Dedup-Snapshotter

### 3.1 构建项目

```bash
cd /home/clg/dedup/dedup-snapshotter

# 构建主程序
make build

# 查看构建产物
ls -lh bin/dedup-snapshotter
```

### 3.2 安装到系统

```bash
# 使用 Makefile 安装 (推荐)
sudo make install

# 手动安装
sudo install -D -m 0755 bin/dedup-snapshotter /usr/local/bin/dedup-snapshotter
sudo bash scripts/install.sh
```

### 3.3 配置文件说明

安装后会生成配置文件 `/etc/dedup-snapshotter/config.json`:

```json
{
  "root": "/var/lib/containerd/io.containerd.snapshotter.v1.dedup",
  "enable_erofs": true,
  "enable_fscache": true,
  "enable_lazy": true,
  "enable_mem_dedup": true,
  "registry": "",
  "chunk_size": 4194304,
  "log_level": "info",
  "prefetch": {
    "enabled": true,
    "workers": 4,
    "queue_size": 1000,
    "trace_dir": "/var/lib/containerd/io.containerd.snapshotter.v1.dedup/traces"
  },
  "ksm": {
    "enabled": true,
    "scan_interval": 100,
    "pages_to_scan": 100,
    "merge_across_nodes": false
  },
  "dedupd": {
    "enabled": true,
    "workers": 4,
    "registry": "https://registry-1.docker.io",
    "fscache_domain": "dedup-snapshotter"
  }
}
```

**关键配置项说明:**
- `enable_erofs`: 启用 EROFS 文件系统
- `enable_fscache`: 启用内核 fscache (需要内核支持)
- `enable_lazy`: 启用按需加载
- `enable_mem_dedup`: 启用内存去重 (KSM)
- `chunk_size`: 数据块大小 (默认 4MB)
- `prefetch.workers`: 预取工作线程数量

---

## 四、配置 Containerd

### 4.1 编辑 containerd 配置

编辑 `/etc/containerd/config.toml`,添加 dedup-snapshotter 作为 proxy plugin:

```toml
version = 2

[plugins."io.containerd.grpc.v1.cri"]
  # 其他配置...

# 添加 dedup snapshotter 配置
[proxy_plugins]
  [proxy_plugins.dedup]
    type = "snapshot"
    address = "/run/containerd/dedup-snapshotter.sock"
```

### 4.2 重启 containerd

```bash
# 重新加载配置并重启 containerd
sudo systemctl daemon-reload
sudo systemctl restart containerd

# 检查 containerd 状态
sudo systemctl status containerd
```

---

## 五、启动 Dedup-Snapshotter

### 5.1 使用 systemd 启动 (推荐)

```bash
# 启动服务
sudo systemctl start dedup-snapshotter

# 设置开机自启
sudo systemctl enable dedup-snapshotter

# 查看服务状态
sudo systemctl status dedup-snapshotter

# 查看日志
sudo journalctl -u dedup-snapshotter -f
```

### 5.2 手动启动 (调试用)

```bash
# 前台运行,方便调试
sudo /usr/local/bin/dedup-snapshotter

# 后台运行
sudo nohup /usr/local/bin/dedup-snapshotter > /var/log/dedup-snapshotter.log 2>&1 &
```

### 5.3 验证启动成功

```bash
# 检查 socket 文件是否存在
ls -l /run/containerd/dedup-snapshotter.sock

# 检查 containerd 是否识别到 snapshotter
sudo ctr plugins ls | grep dedup
```

---

## 六、使用 Dedup-Snapshotter 拉取镜像

### 6.1 基本镜像拉取

#### 方法一：使用 ctr 命令

```bash
# 拉取镜像,指定使用 dedup snapshotter
sudo ctr image pull --snapshotter=dedup docker.io/library/nginx:latest

# 查看镜像
sudo ctr image ls

# 查看使用的 snapshotter
sudo ctr snapshot ls --snapshotter=dedup
```

#### 方法二：使用 nerdctl (推荐)

```bash
# 安装 nerdctl (如果还没安装)
# 下载: https://github.com/containerd/nerdctl/releases

# 拉取镜像
sudo nerdctl --snapshotter=dedup pull nginx:latest

# 查看镜像
sudo nerdctl images
```

### 6.2 拉取测试镜像 (按需加载验证)

根据测试要求,拉取指定的测试镜像:

```bash
# 拉取 DockerHub 测试镜像
sudo ctr image pull --snapshotter=dedup docker.io/godnf/tst-lazy-pull:latest

# 或使用 nerdctl
sudo nerdctl --snapshotter=dedup pull godnf/tst-lazy-pull:latest
```

### 6.3 查看去重效果

```bash
# 查看存储使用情况
sudo du -sh /var/lib/containerd/io.containerd.snapshotter.v1.dedup/

# 查看数据块去重数据库
sudo ls -lh /var/lib/containerd/io.containerd.snapshotter.v1.dedup/index.db

# 查看审计日志
sudo sqlite3 /var/lib/containerd/io.containerd.snapshotter.v1.dedup/audit.db "SELECT * FROM audit_logs ORDER BY timestamp DESC LIMIT 10;"
```

---

## 七、运行容器 (验证按需加载)

### 7.1 运行容器

```bash
# 使用 ctr 运行容器
sudo ctr run --snapshotter=dedup --rm -t docker.io/godnf/tst-lazy-pull:latest test-container /bin/sh

# 使用 nerdctl 运行容器
sudo nerdctl --snapshotter=dedup run --rm -it godnf/tst-lazy-pull:latest /bin/sh
```

### 7.2 监控资源使用

在拉取镜像和启动容器时,使用监控脚本记录资源开销:

```bash
# 启动资源监控脚本
bash /home/clg/dedup/monitor_resource.sh &

# 记录进程 ID
MONITOR_PID=$!

# 执行拉取和启动操作
sudo ctr image pull --snapshotter=dedup docker.io/godnf/tst-lazy-pull:latest
sudo ctr run --snapshotter=dedup --rm -t docker.io/godnf/tst-lazy-pull:latest test-container /bin/sh -c "md5sum /path/to/file"

# 停止监控
kill $MONITOR_PID
```

---

## 八、按需加载工作原理

### 8.1 工作流程

```
1. 镜像拉取
   ↓
2. 层数据块级切分 (4MB)
   ↓
3. 计算 SHA256 哈希
   ↓
4. 检查本地是否已存在 (去重)
   ↓
5. 构建 EROFS 镜像
   ↓
6. 使用 fscache/loop 设备挂载
   ↓
7. 容器启动 (只下载必需的块)
```

### 8.2 按需加载机制

**模式一: Fscache 模式** (推荐,需要内核 5.15+)
- 使用内核 fscache 机制
- 自动按需下载数据块
- 更高性能,更低延迟

**模式二: LazyLoader 模式** (降级方案)
- 用户态懒加载实现
- 通过预取队列优化性能
- 兼容旧内核

### 8.3 预取优化

项目支持基于访问追踪的预取:

```bash
# 记录容器文件访问顺序
# 生成 trace 文件到: /var/lib/containerd/io.containerd.snapshotter.v1.dedup/traces/

# 下次启动时会根据 trace 文件预取数据块
```

---

## 九、性能测试对比

### 9.1 冷启动测试

#### 测试前准备
```bash
# 清理所有镜像缓存
sudo ctr image rm $(sudo ctr image ls -q)

# 清理 snapshotter 数据
sudo rm -rf /var/lib/containerd/io.containerd.snapshotter.v1.dedup/*

# 重启服务
sudo systemctl restart dedup-snapshotter
sudo systemctl restart containerd
```

#### 非按需加载 (传统 Docker)
```bash
# 记录开始时间
time sudo docker pull godnf/tst-lazy-pull:latest
time sudo docker run --rm godnf/tst-lazy-pull:latest /bin/sh -c "exit"
```

#### 按需加载 (Dedup-Snapshotter)
```bash
# 记录开始时间
time sudo ctr image pull --snapshotter=dedup docker.io/godnf/tst-lazy-pull:latest
time sudo ctr run --snapshotter=dedup --rm docker.io/godnf/tst-lazy-pull:latest test /bin/sh -c "exit"
```

### 9.2 存储去重测试

```bash
# 拉取多个相关镜像
sudo ctr image pull --snapshotter=dedup docker.io/library/ubuntu:20.04
sudo ctr image pull --snapshotter=dedup docker.io/library/ubuntu:22.04
sudo ctr image pull --snapshotter=dedup docker.io/library/nginx:latest

# 查看实际存储占用
sudo du -sh /var/lib/containerd/io.containerd.snapshotter.v1.dedup/chunks/

# 查看去重统计
sudo sqlite3 /var/lib/containerd/io.containerd.snapshotter.v1.dedup/index.db \
  "SELECT COUNT(*), SUM(size) FROM chunks WHERE ref_count > 1;"
```

---

## 十、故障排查

### 10.1 常见问题

#### 问题1: snapshotter 无法启动
```bash
# 检查日志
sudo journalctl -u dedup-snapshotter -n 100

# 检查配置文件
cat /etc/dedup-snapshotter/config.json

# 检查目录权限
ls -ld /var/lib/containerd/io.containerd.snapshotter.v1.dedup/
```

#### 问题2: containerd 无法识别 snapshotter
```bash
# 检查 socket 文件
ls -l /run/containerd/dedup-snapshotter.sock

# 检查 containerd 配置
cat /etc/containerd/config.toml | grep -A 5 proxy_plugins

# 重启服务
sudo systemctl restart dedup-snapshotter containerd
```

#### 问题3: EROFS 挂载失败
```bash
# 检查 erofs 模块
lsmod | grep erofs
sudo modprobe erofs

# 检查 mkfs.erofs
which mkfs.erofs
mkfs.erofs --version
```

#### 问题4: KSM 不工作
```bash
# 检查 KSM 状态
cat /sys/kernel/mm/ksm/run
cat /sys/kernel/mm/ksm/pages_sharing

# 手动启用 KSM
echo 1 | sudo tee /sys/kernel/mm/ksm/run
```

### 10.2 调试模式

```bash
# 修改日志级别为 debug
sudo vi /etc/dedup-snapshotter/config.json
# 修改 "log_level": "debug"

# 重启服务
sudo systemctl restart dedup-snapshotter

# 实时查看详细日志
sudo journalctl -u dedup-snapshotter -f
```

---

## 十一、API 接口使用

Dedup-Snapshotter 提供了 HTTP API 接口 (默认端口 8080):

### 11.1 查看配置
```bash
curl http://localhost:8080/config
```

### 11.2 更新配置
```bash
curl -X POST http://localhost:8080/config \
  -H "Content-Type: application/json" \
  -d '{
    "ksm": {
      "enabled": true,
      "scan_interval": 200
    }
  }'
```

### 11.3 查看审计日志
```bash
curl http://localhost:8080/audit/logs?limit=20
```

---

## 十二、生产环境建议

### 12.1 性能优化

```json
{
  "chunk_size": 4194304,
  "prefetch": {
    "enabled": true,
    "workers": 8,
    "queue_size": 2000
  },
  "ksm": {
    "enabled": true,
    "scan_interval": 100,
    "pages_to_scan": 200
  }
}
```

### 12.2 监控建议

- 定期检查 `/var/lib/containerd/io.containerd.snapshotter.v1.dedup/` 磁盘使用
- 监控 KSM 去重效果: `cat /sys/kernel/mm/ksm/pages_sharing`
- 定期清理审计日志 (自动清理 30 天前的记录)

### 12.3 备份建议

```bash
# 备份配置
sudo cp /etc/dedup-snapshotter/config.json /etc/dedup-snapshotter/config.json.bak

# 备份索引数据库
sudo cp /var/lib/containerd/io.containerd.snapshotter.v1.dedup/index.db \
  /var/lib/containerd/io.containerd.snapshotter.v1.dedup/index.db.bak
```

---

## 附录：关键文件路径

| 路径 | 说明 |
|------|------|
| `/usr/local/bin/dedup-snapshotter` | 主程序二进制 |
| `/etc/dedup-snapshotter/config.json` | 配置文件 |
| `/run/containerd/dedup-snapshotter.sock` | Unix socket |
| `/var/lib/containerd/io.containerd.snapshotter.v1.dedup/` | 数据根目录 |
| `/var/lib/containerd/io.containerd.snapshotter.v1.dedup/snapshots/` | 快照目录 |
| `/var/lib/containerd/io.containerd.snapshotter.v1.dedup/chunks/` | 数据块存储 |
| `/var/lib/containerd/io.containerd.snapshotter.v1.dedup/index.db` | 去重索引数据库 |
| `/var/lib/containerd/io.containerd.snapshotter.v1.dedup/audit.db` | 审计日志数据库 |
| `/var/lib/containerd/io.containerd.snapshotter.v1.dedup/images/` | EROFS 镜像 |
| `/var/log/dedup-snapshotter/` | 日志目录 |
